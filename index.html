<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boolean Expression Simplifier</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Load thư viện simplify trước script chính -->
  <script src="https://cdn.jsdelivr.net/npm/boolean-expression-simplifier/dist/bundle.min.js" defer></script>
</head>
<body>
  
  <!-- Dropdown nhỏ góc trái -->
  <div class="dropdown-box">
    <button class="dropdown-btn" id="definedByBtn">Defined by ▼</button>
    <div class="dropdown-menu" id="definedByMenu">
      <div class="option">Karnaugh map</div>
      <div class="option">Boolean Expression</div>
      <div class="option">Minterm</div>
      <div class="option">Maxterm</div>
      <div class="option">Truth Table</div>
    </div>
  </div>

  <!-- Dropdown variables -->
  <div class="var-box">
    <button class="var-selected" id="varSelected">4 variables ▼</button>
    <div class="var-menu" id="varMenu">
      <div class="var-option">2 variables</div>
      <div class="var-option">3 variables</div>
      <div class="var-option">4 variables</div>
      <div class="var-option">5 variables</div>
      <div class="var-option">6 variables</div>
    </div>
  </div>

  <!-- ===== Boolean Expression Workspace ===== -->
  <div class="expr-container">
    <div class="expr-title">Boolean Expression</div>
  
    <div class="expr-row">
      <label>Standard expression:</label>
      <input type="text" id="standardExpr" autocomplete="off" />
    </div>
  
    <div class="expr-row">
      <label>Don't care terms:</label>
      <input type="text" id="dontCareExpr" autocomplete="off" />
    </div>
  
    <div class="expr-row">
      <label>Simplified expression:</label>
      <input type="text" id="simplifiedExpr" disabled />
    </div>
  
    <button id="instructionBtn">Instruction</button>
  </div>
  
  <!-- ===== Instruction Popup ===== -->
  <div class="popup-overlay" id="popupOverlay">
    <div class="popup">
      <h3>Instruction</h3>
      <pre id="instructionContent"></pre>
    </div>
  </div>

  <script defer>
    window.onload = () => {
      const definedByBtn = document.getElementById("definedByBtn");
      const definedByMenu = document.getElementById("definedByMenu");
      const varSelected = document.getElementById("varSelected");
      const varMenu = document.getElementById("varMenu");
      const instructionBtn = document.getElementById("instructionBtn");
      const popupOverlay = document.getElementById("popupOverlay");
      const popup = popupOverlay.querySelector(".popup");
      const instructionContent = document.getElementById("instructionContent");
      const standardExpr = document.getElementById("standardExpr");
      const simplifiedExpr = document.getElementById("simplifiedExpr");

      const VARS = ["A", "B", "C", "D", "E", "F"];
      let variableCount = 4;

      // ===== Dropdowns =====
      definedByBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        if (varMenu.classList.contains("show")) varMenu.classList.remove("show");
        definedByMenu.classList.toggle("show");
      });

      varSelected.addEventListener("click", (e) => {
        e.stopPropagation();
        if (definedByMenu.classList.contains("show")) definedByMenu.classList.remove("show");
        varMenu.classList.toggle("show");
      });

      definedByMenu.querySelectorAll(".option").forEach(option => {
        option.addEventListener("click", () => definedByMenu.classList.remove("show"));
      });

      varMenu.querySelectorAll(".var-option").forEach(option => {
        option.addEventListener("click", () => {
          variableCount = parseInt(option.innerText);
          varSelected.innerText = option.innerText + " ▼";
          varMenu.classList.remove("show");
          updateInstruction();
        });
      });

      window.addEventListener("click", () => {
        definedByMenu.classList.remove("show");
        varMenu.classList.remove("show");
      });

      // ===== Instruction popup =====
      instructionBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        popupOverlay.style.display = popupOverlay.style.display === "block" ? "none" : "block";
      });

      popupOverlay.addEventListener("click", () => popupOverlay.style.display = "none");
      popup.addEventListener("click", (e) => e.stopPropagation());

      // ===== Instruction content =====
      function updateInstruction() {
        const vars = VARS.slice(0, variableCount).join(", ");
        instructionContent.textContent = `
Allowed variables: ${vars}

Operators:
+  : OR
*  : AND
'  : NOT
x  : XOR
( ) : Group

Invalid characters will be removed automatically.
        `;
      }

      // ===== Xử lý XOR và rút gọn =====
      function convertXORtoStandard(expr) {
        let newExpr = expr;
        const xorRegex = /([A-Z]) x ([A-Z])/;
        while (xorRegex.test(newExpr)) {
          newExpr = newExpr.replace(xorRegex, "($1'*$2 + $1*$2')");
        }
        return newExpr;
      }

      standardExpr.addEventListener("input", () => {
        const allowedVars = VARS.slice(0, variableCount);
        const allowedOps = ["+", "*", "'", "x", "(", ")", " "];

        // Loại ký tự không hợp lệ
        let cleaned = "";
        for (let ch of standardExpr.value) {
          if (allowedVars.includes(ch) || allowedOps.includes(ch)) cleaned += ch;
        }
        if (cleaned !== standardExpr.value) standardExpr.value = cleaned;

        // Loại bỏ khoảng trắng
        const cleanedExpr = cleaned.replace(/\s+/g, '');
        // Chuyển XOR
        const standardExprConverted = convertXORtoStandard(cleanedExpr);

        // Rút gọn với thư viện
        try {
          simplifiedExpr.value = BooleanExpressionSimplifier.simplify(standardExprConverted);
        } catch (e) {
          simplifiedExpr.value = cleaned; // nếu lỗi
        }
      });

      updateInstruction();
    }
  </script>
</body>
</html>

